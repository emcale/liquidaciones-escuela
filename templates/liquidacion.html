<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Liquidaci√≥n - {{ liquidacion.profesor.nombre }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">

    <h2>Liquidaci√≥n ‚Äì {{ liquidacion.profesor.nombre }}</h2>
    <p><strong>Mes:</strong> {{ liquidacion.mes }} {{ liquidacion.anio }}</p>
    <p><strong>Fecha:</strong> {{ liquidacion.fecha.strftime('%d/%m/%Y') }}</p>

    <div class="mb-3 d-flex gap-2">
        <a class="btn btn-secondary" href="{{ url_for('liquidaciones') }}">‚Üê Volver al listado</a>
        <a class="btn btn-success" href="{{ url_for('liquidacion_pdf', liquidacion_id=liquidacion.id) }}">
            üìÑ Descargar PDF
        </a>
    </div>

    <!-- FORMULARIO AGREGAR DETALLE -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title mb-3">Agregar detalle</h4>

            <form method="POST"
                  action="{{ url_for('agregar_detalle', liquidacion_id=liquidacion.id) }}"
                  class="row g-2"
                  oninput="calcularSubtotal()">

                <div class="col-md-2">
                    <select class="form-select" name="materia" required>
                        {% for m in materias %}
                        <option value="{{ m.nombre }}">{{ m.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <input class="form-control" type="text" name="horario" placeholder="Horario">
                </div>

                <div class="col-md-3">
                    <input class="form-control" type="text" name="comentario" placeholder="Comentario">
                </div>

                <div class="col-md-1">
                    <input class="form-control" type="number" name="cantidad_alumnos" id="cantidad_alumnos"
                           placeholder="Alumnos" required>
                </div>

                <div class="col-md-1">
                    <input class="form-control" type="number" step="any" name="horas_mes" id="horas_mes"
                           placeholder="Horas" required>
                </div>

                <div class="col-md-1">
                    <input class="form-control" type="number" step="any" name="valor_hora" id="valor_hora"
                           placeholder="$ / hora" readonly>
                </div>

                <div class="col-md-2">
                    <input class="form-control" type="text" id="subtotal_preview" placeholder="Subtotal" readonly>
                </div>

                <div class="col-md-12 mt-2">
                    <button type="submit" class="btn btn-primary w-100">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- LISTADO DE DETALLES -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h4 class="card-title mb-3">Detalles</h4>

            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Materia</th>
                        <th>Horario</th>
                        <th>Comentario</th>
                        <th>Alumnos</th>
                        <th>Horas</th>
                        <th>$ / Hora</th>
                        <th>Subtotal</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="tabla-detalles">
                    {% for d in detalles_ordenados %}
                    <tr data-horario="{{ d.horario }}">
                        <td>{{ d.materia }}</td>
                        <td>{{ d.horario }}</td>
                        <td>{{ d.comentario }}</td>
                        <td>{{ d.cantidad_alumnos }}</td>
                        <td>{{ "%.2f"|format(d.horas_mes) }}</td>
                        <td>{{ "%.2f"|format(d.valor_hora) }}</td>
                        <td>{{ "%.2f"|format(d.subtotal) }}</td>
                        <td>
                            <a class="btn btn-sm btn-warning" href="{{ url_for('editar_detalle', detalle_id=d.id) }}">Editar</a>
                            <a class="btn btn-sm btn-danger" href="{{ url_for('borrar_detalle', detalle_id=d.id) }}">Borrar</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h4 class="text-end">Total: ${{ "%.2f"|format(total) }}</h4>
        </div>
    </div>

</div>

<script>

async function calcularSubtotal() {
    const alumnos = parseInt(document.getElementById('cantidad_alumnos').value) || 0;
    const horas = parseFloat(document.getElementById('horas_mes').value) || 0;

    if (alumnos === 0 || horas === 0) {
        document.getElementById('valor_hora').value = '';
        document.getElementById('subtotal_preview').value = '';
        return;
    }

    try {
        const response = await fetch(`/calcular_valor_hora?profesor_id={{ liquidacion.profesor.id }}&cantidad_alumnos=${alumnos}`);
        const data = await response.json();
        const valor = parseFloat(data.valor_hora) || 0;
        document.getElementById('valor_hora').value = valor.toFixed(2);
        document.getElementById('subtotal_preview').value = '$ ' + (valor * horas).toFixed(2);
    } catch (e) {
        console.error(e);
    }
}

/* ORDENAR DETALLES POR DIA Y HORA */
document.addEventListener("DOMContentLoaded", function () {

    const diasOrden = {
        "Lunes": 1,
        "Martes": 2,
        "Mi√©rcoles": 3,
        "Miercoles": 3,
        "Jueves": 4,
        "Viernes": 5,
        "S√°bado": 6,
        "Sabado": 6,
        "Domingo": 7
    };

    const tbody = document.getElementById("tabla-detalles");
    const filas = Array.from(tbody.querySelectorAll("tr"));

    filas.sort((a, b) => {

        const horarioA = a.dataset.horario || "";
        const horarioB = b.dataset.horario || "";

        const diaA = horarioA.split(" ")[0];
        const diaB = horarioB.split(" ")[0];

        const horaA = horarioA.match(/\d+/);
        const horaB = horarioB.match(/\d+/);

        const ordenDia = (diasOrden[diaA] || 99) - (diasOrden[diaB] || 99);
        if (ordenDia !== 0) return ordenDia;

        return (horaA ? parseInt(horaA[0]) : 0) - (horaB ? parseInt(horaB[0]) : 0);
    });

    filas.forEach(fila => tbody.appendChild(fila));
});

</script>

</body>
</html>