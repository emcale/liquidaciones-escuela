<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Liquidaciones</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="p-4">

<h2>Listado de Liquidaciones</h2>

<!-- ================= FILTROS ================= -->
<form method="get" action="{{ url_for('liquidaciones') }}" class="row g-3 mb-3">

    <div class="col-auto">
        <select name="profesor_id" class="form-select">
            <option value="">Todos los profesores</option>
            {% for p in profesores %}
                <option value="{{ p.id }}" {% if filtro_profesor == p.id %}selected{% endif %}>
                    {{ p.nombre }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-auto">
        <select name="mes" class="form-select">
            <option value="">Todos los meses</option>
            {% for m in ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'] %}
                <option value="{{ m }}" {% if filtro_mes == m %}selected{% endif %}>
                    {{ m }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-auto">
        <input type="number"
               name="anio"
               placeholder="A√±o"
               value="{{ filtro_anio or '' }}"
               class="form-control"
               min="2000"
               max="2100">
    </div>

    <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtrar</button>
    </div>

</form>

<!-- ================= TABLA ================= -->
<table class="table table-bordered table-striped">

    <thead class="table-dark">
        <tr>
            <th><input type="checkbox" id="selectAll"></th>
            <th>Profesor</th>
            <th>Mes</th>
            <th>A√±o</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
    {% for l in liquidaciones %}
    <tr>
        <td>
            <input type="checkbox" name="liquidacion_ids" value="{{ l.id }}">
        </td>
        <td>{{ l.profesor }}</td>
        <td>{{ l.mes }}</td>
        <td>{{ l.anio }}</td>
        <td>{{ l.fecha.strftime('%d/%m/%Y') }}</td>
        <td class="text-end">
            ${{ "{:,.2f}".format(l.total) }}
        </td>
        <td class="d-flex gap-1">

            <a class="btn btn-primary btn-sm"
               href="{{ url_for('editar_liquidacion', liquidacion_id=l.id) }}"
               title="Ver / Editar">üëÅÔ∏è</a>

            <a class="btn btn-danger btn-sm"
               href="{{ url_for('borrar_liquidacion', liquidacion_id=l.id) }}"
               onclick="return confirm('¬øBorrar esta liquidaci√≥n?')"
               title="Borrar">üóëÔ∏è</a>

            <a class="btn btn-success btn-sm"
               href="{{ url_for('liquidacion_pdf', liquidacion_id=l.id) }}"
               title="Descargar PDF">üìÑ</a>

        </td>
    </tr>
    {% endfor %}

    <!-- üîπ FILA TOTAL PROFESIONAL -->
    <tr class="fw-bold" style="border-top: 3px solid #000;">
        <td colspan="5" class="text-end">
            TOTAL LIQUIDADO ‚Üí
        </td>
        <td class="text-end text-success">
            ${{ "{:,.2f}".format(total_general) }}
        </td>
        <td></td>
    </tr>

</tbody>

</table>

<!-- ================= ACCIONES MASIVAS ================= -->
<div class="mb-3 d-flex flex-wrap gap-2">

    <!-- EXPORTAR SELECCIONADAS -->
    <form id="form-exportar-seleccionadas"
          method="post"
          action="{{ url_for('exportar_pdfs_masivos') }}">
        <button type="submit" class="btn btn-success">
            üìÑ Exportar PDFs seleccionados
        </button>
    </form>

    <!-- EXPORTAR FILTRO -->
    <form method="get" action="{{ url_for('exportar_pdfs_filtro') }}">
        <input type="hidden" name="profesor_id" value="{{ filtro_profesor or '' }}">
        <input type="hidden" name="mes" value="{{ filtro_mes or '' }}">
        <input type="hidden" name="anio" value="{{ filtro_anio or '' }}">
        <button type="submit" class="btn btn-info">
            üìÑ Exportar todo el filtro
        </button>
    </form>

    <!-- BORRAR SELECCIONADAS -->
    <button id="btn-borrar-seleccionadas" class="btn btn-danger">
        üóëÔ∏è Borrar seleccionadas
    </button>

    <!-- BORRAR TODAS -->
    <form method="post" action="{{ url_for('borrar_liquidaciones') }}">
        <input type="hidden" name="delete_all" value="1">
        <button type="submit"
                class="btn btn-danger"
                onclick="return confirm('¬øBORRAR TODAS las liquidaciones?')">
            ‚ùå Borrar todas
        </button>
    </form>

    <!-- WHATSAPP -->
    <form id="form-whatsapp">
        <button type="submit" class="btn btn-warning">
            üì≤ Enviar PDFs por WhatsApp
        </button>
    </form>

</div>

<a href="{{ url_for('index') }}" class="btn btn-secondary">
    ‚Üê Volver al inicio
</a>

<!-- ================= MODAL WHATSAPP ================= -->
<div class="modal fade" id="modalWhatsapp" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-body text-center p-4">

                <div id="estado-envio">
                    <div class="spinner-border text-warning mb-3"></div>
                    <h5>Enviando WhatsApp‚Ä¶</h5>
                    <p class="text-muted">Por favor, esper√°</p>
                </div>

                <div id="resultado-envio" class="d-none">
                    <h5 id="resultado-titulo"></h5>
                    <div id="lista-fallidos" class="mt-3 text-start"></div>
                    <button class="btn btn-secondary mt-3" data-bs-dismiss="modal">
                        Cerrar
                    </button>
                </div>

            </div>

        </div>
    </div>
</div>

<!-- ================= SCRIPTS ================= -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* SELECT ALL */
document.getElementById('selectAll').addEventListener('click', function () {
    document.querySelectorAll('input[name="liquidacion_ids"]')
        .forEach(ch => ch.checked = this.checked);
});

/* EXPORTAR */
document.getElementById('form-exportar-seleccionadas').addEventListener('submit', function (e) {
    let seleccionados = document.querySelectorAll('input[name="liquidacion_ids"]:checked');
    if (!seleccionados.length) {
        e.preventDefault();
        alert("Selecciona al menos una liquidaci√≥n.");
        return;
    }

    this.querySelectorAll('input[name="liquidacion_ids"]').forEach(i => i.remove());
    seleccionados.forEach(ch => {
        let i = document.createElement('input');
        i.type = 'hidden';
        i.name = 'liquidacion_ids';
        i.value = ch.value;
        this.appendChild(i);
    });
});

/* WHATSAPP */
document.getElementById('form-whatsapp').addEventListener('submit', async function (e) {
    e.preventDefault();

    let seleccionados = document.querySelectorAll('input[name="liquidacion_ids"]:checked');
    if (!seleccionados.length) {
        alert("Selecciona al menos una liquidaci√≥n.");
        return;
    }

    let data = new FormData();
    seleccionados.forEach(ch => data.append('liquidacion_ids', ch.value));

    let modal = new bootstrap.Modal(document.getElementById('modalWhatsapp'));
    modal.show();

    let res = await fetch("{{ url_for('enviar_whatsapp') }}", {
        method: 'POST',
        body: data
    });

    let json = await res.json();

    document.getElementById('estado-envio').classList.add('d-none');
    document.getElementById('resultado-envio').classList.remove('d-none');

    if (json.fallidos.length === 0) {
        document.getElementById('resultado-titulo').innerText =
            "‚úÖ Comprobantes enviados correctamente";
    } else {
        document.getElementById('resultado-titulo').innerText =
            "‚ö†Ô∏è Algunos env√≠os fallaron";

        document.getElementById('lista-fallidos').innerHTML =
            "<strong>No se pudo enviar a:</strong><ul>" +
            json.fallidos.map(n => `<li>${n}</li>`).join("") +
            "</ul>";
    }
});

/* BORRAR */
document.getElementById('btn-borrar-seleccionadas').addEventListener('click', function () {
    let ids = [...document.querySelectorAll('input[name="liquidacion_ids"]:checked')]
        .map(cb => cb.value);

    if (!ids.length) {
        alert("No seleccionaste ninguna liquidaci√≥n.");
        return;
    }

    if (!confirm("¬øQuer√©s borrar las liquidaciones seleccionadas?")) return;

    let f = document.createElement('form');
    f.method = 'POST';
    f.action = "{{ url_for('borrar_liquidaciones') }}";

    ids.forEach(id => {
        let i = document.createElement('input');
        i.type = 'hidden';
        i.name = 'liquidacion_ids';
        i.value = id;
        f.appendChild(i);
    });

    document.body.appendChild(f);
    f.submit();
});
</script>

</body>
</html>
